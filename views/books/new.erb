<script type="text/javascript" src="/google_books.js"></script>

<p>
  <google-books></google-books>
</p>

<form action="/users/<%= user.slug %>/books/<%= book.isbn if book.persisted? %>" method="POST">
  <input type="hidden" name="authenticity_token" value="<%= env['rack.session'][:csrf] %>">
  <input type="hidden" name="google_books_id" value="<%=book.google_books_id %>">

  <div class="field">
    <label class="label">Title</label>
    <div class="control">
      <input
          class="input <%= 'is-danger' if book.errors.include?(:title) %>"
          type="text"
          name="title"
          value="<%=h book.title %>"
          onchange="document.getElementsByTagName('google-books')[0].setAttribute('keyword', this.value)"
          required
          autofocus>
      <% if book.errors.include?(:title) %>
        <p class="help is-danger"><%= book.errors.full_messages_for(:title).join %></p>
      <% end %>
    </div>
  </div>

  <% unless book.persisted? %>
    <div class="field">
      <label class="label">ISBN</label>
      <div class="control">
        <input
            class="input <%= 'is-danger' if book.errors.include?(:isbn) %>"
            type="number"
            name="isbn"
            value="<%=h book.isbn %>"
            onchange="document.getElementsByTagName('google-books')[0].setAttribute('keyword', `isbn:${this.value}`)"
            required>
        <% if book.errors.include?(:isbn) %>
          <p class="help is-danger"><%= book.errors.full_messages_for(:isbn).join %></p>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="field">
    <label class="label">Author</label>
    <div class="control">
      <input
          class="input <%= 'is-danger' if book.errors.include?(:author) %>"
          type="text"
          name="author"
          onchange="document.getElementsByTagName('google-books')[0].setAttribute('keyword', this.value)"
          value="<%=h book.author %>"
          required>
      <% if book.errors.include?(:author) %>
        <p class="help is-danger"><%= book.errors.full_messages_for(:author).join %></p>
      <% end %>
    </div>
  </div>

  <details class="field">
    <summary>Optional details</summary>

    <div class="field">
      <label class="label">Subtitle</label>
      <div class="control">
        <input
            class="input <%= 'is-danger' if book.errors.include?(:subtitle) %>"
            type="text"
            name="subtitle"
            value="<%=h book.subtitle %>">
        <% if book.errors.include?(:subtitle) %>
          <p class="help is-danger"><%= book.errors.full_messages_for(:subtitle).join %></p>
        <% end %>
      </div>
    </div>

    <div class="field">
      <label class="label">Description</label>
      <div class="control">
        <textarea
            class="textarea <%= 'is-danger' if book.errors.include?(:description) %>"
            name="description"><%=h book.description %></textarea>
        <% if book.errors.include?(:description) %>
          <p class="help is-danger"><%=h book.errors.full_messages_for(:description).join %></p>
        <% end %>
      </div>
    </div>

    <div class="field">
      <label class="label">Publisher</label>
      <div class="control">
        <input
            class="input <%= 'is-danger' if book.errors.include?(:publisher) %>"
            type="text"
            name="publisher"
            value="<%=h book.publisher %>">
        <% if book.errors.include?(:publisher) %>
          <p class="help is-danger"><%= book.errors.full_messages_for(:publisher).join %></p>
        <% end %>
      </div>
    </div>

    <div class="field">
      <label class="label">Pages</label>
      <div class="control">
        <input
            class="input <%= 'is-danger' if book.errors.include?(:page_count) %>"
            type="number"
            name="page_count"
            value="<%=h book.page_count %>">
        <% if book.errors.include?(:page_count) %>
          <p class="help is-danger"><%= book.errors.full_messages_for(:page_count).join %></p>
        <% end %>
      </div>
    </div>

  </details>

  <div class="field is-grouped">
    <div class="control">
      <button class="button is-link">Save</button>
    </div>
  </div>
</form>

<% if book.persisted? %>
  <form action="/users/<%= user.slug %>/books/<%=h book.isbn %>" method="POST" class="has-text-right">
    <input type="hidden" name="_method" value="DELETE">
    <input type=hidden name=authenticity_token value="<%= env['rack.session'][:csrf] %>">
    <button class="button is-danger">Delete!</button>
  </form>
<% end %>
